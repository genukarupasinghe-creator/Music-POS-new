<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Admin - Musical POS</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        body { font-family: sans-serif; background: #f4f4f4; padding: 10px; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; margin: 5px; }
        .btn-close { background: #dc3545; }
        .btn-open { background: #28a745; }
        .btn-excel { background: #217346; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #333; color: white; }
        #reader { width: 100%; max-width: 400px; margin: auto; }
        #login-box { max-width: 300px; margin: 100px auto; text-align: center; }
        input { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="login-box" class="card">
        <h2>Admin Login</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button class="btn" style="background: #007bff; width: 100%;" onclick="login()">Login</button>
    </div>

    <div id="admin-content" style="display:none;">
        
        <div class="card">
            <h3>üö´ Ticket Control (Sold Out)</h3>
            <div id="controls">
                <button class="btn btn-close" onclick="toggleShow('Flashback Live', 'closed')">Sold Out: Flashback</button>
                <button class="btn btn-close" onclick="toggleShow('Sunflower Unplugged', 'closed')">Sold Out: Sunflower</button>
                <button class="btn btn-open" onclick="toggleShow('Flashback Live', 'open')">Reset All to Open</button>
            </div>
        </div>

        <div class="card">
            <h3>üîç Gate Entry Scanner</h3>
            <div id="reader"></div>
            <div id="scan-result" style="margin-top:10px; text-align:center;"></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content: space-between;">
                <h3>üìä Sales Records</h3>
                <button class="btn btn-excel" onclick="exportToExcel()">Download Excel</button>
            </div>
            <table id="bookingTable">
                <thead>
                    <tr><th>Name</th><th>Show</th><th>Price</th><th>Time</th></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <button class="btn" style="background: #666;" onclick="firebase.auth().signOut().then(()=>location.reload())">Logout</button>
    </div>

<script>
    // ‚ö†Ô∏è Insert your Firebase Config here
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // LOGIN
    function login() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        firebase.auth().signInWithEmailAndPassword(e, p)
            .catch(err => alert(err.message));
    }

    firebase.auth().onAuthStateChanged(user => {
        if(user) {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            loadData();
            startScanner();
        }
    });

    // SOLD OUT TOGGLE
    function toggleShow(name, status) {
        db.collection("showSettings").doc(name).set({ status: status })
            .then(() => alert(name + " is now " + status));
    }

    // LOAD TABLE
    function loadData() {
        db.collection("bookings").orderBy("timestamp", "desc").onSnapshot(snap => {
            let html = "";
            snap.forEach(doc => {
                const d = doc.data();
                html += `<tr><td>${d.customerName}</td><td>${d.showName}</td><td>${d.amount}</td><td>${d.timestamp?d.timestamp.toDate().toLocaleString():''}</td></tr>`;
            });
            document.getElementById('tableBody').innerHTML = html;
        });
    }

    // EXPORT
    function exportToExcel() {
        XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById("bookingTable")), "Sales.xlsx");
    }

    // QR SCANNER
    function startScanner() {
        const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        scanner.render((id) => {
            db.collection("bookings").doc(id).get().then(doc => {
                const res = document.getElementById('scan-result');
                if(doc.exists) {
                    res.innerHTML = `<b style="color:green">‚úÖ VALID: ${doc.data().customerName}</b>`;
                } else {
                    res.innerHTML = `<b style="color:red">‚ùå INVALID TICKET</b>`;
                }
            });
        });
    }
</script>
</body>
</html>
